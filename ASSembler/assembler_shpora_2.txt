–≠—Ç–æ—Ç –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω —Å—Ç—É–¥–µ–Ω—Ç–æ–º 23217 –≥—Ä—É–ø–ø—ã
"—Å–ø–∞—Å–∏–±–æ" —Å—é–¥—ãüòÅ: tg @martynovbogdan


–°–ª–æ–≤–∞—Ä—å:
rn ‚Äî –∫–∞–∫–æ–π-—Ç–æ —Ä–µ–≥–∏—Å—Ç—Ä
offset ‚Äî —Å–º–µ—â–µ–Ω–∏–µ
PC ‚Äî –∞–¥—Ä–µ—Å –≤ –ø–∞–º—è—Ç–∏, –∫–æ–º–∞–Ω–¥–∞ –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è
SP ‚Äî –∞–¥—Ä–µ—Å –ø–∞–º—è—Ç–∏, –æ—Ç–∫—É–¥–∞ pop
<const> ‚Äî –∫–∞–∫–∞—è-—Ç–æ –º–µ—Ç–∫–∞ (label), –Ω–∞–ø—Ä–∏–º–µ—Ä, mult
! ‚Äî not (–æ—Ç—Ä–∏—Ü–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π)

# ===

–£—Å–ª–æ–≤–∏—è –¥–ª—è is / stays / until:
condition	flag				interpretation
eq/z		Z				equal, equal zero (rj == ri / rn == 0)
ne/nz		!Z				not equal, not zero (ri != rj, rn != 0)
hs/cs		C				unsigned higher or same (–±–µ–∑–∑–Ω–∞–∫–æ–≤–æ–µ >=, )
lo/cc		!C				unsigned lower (–±–µ–∑–∑–Ω–∞–∫–æ–≤–æ–µ <, –Ω–∞–ø—Ä–∏–º–µ—Ä, 17 < 193 –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –±–ª–æ–∫ is)
hi		(C & !Z)			unsigned higher (–±–µ–∑–∑–Ω–∞–∫–æ–≤–æ–µ >)
ls		(!C or Z)			unsigned lower or same (–±–µ–∑–∑–Ω–∞–∫–æ–≤–æ–µ <=)
mi		N				negative (–µ—Å–ª–∏ —á–∏—Å–ª–æ < 0, —á–∏—Å–ª–æ <- [-128;-1])
pl		!N				positive or zero (–µ—Å–ª–∏ —á–∏—Å–ª–æ >= 0, —á–∏—Å–ª–æ <- [0; 127])
vs		V				oVerflow is set (–µ—Å–ª–∏ –ø—Ä–∏ —Å–ª–æ–∂–µ–Ω–∏–∏ –¥–≤—É—Ö –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö —á–∏—Å–µ–ª –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ, –∏–ª–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç ‚Äî —Å–ª–æ–∂–∏–ª–∏ –¥–≤–∞ - —á–∏—Å–ª–∞ –∏ –ø–æ–ª—É—á–∏–ª–∏ +)
vc		!V				oVerflow is clear (—Å–ª–æ–∏–∂–∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞ –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ, –∏–ª–∏ —Å–ª–æ–∂–∏–ª–∏ 2 + —á–∏—Å–ª–∞ –∏ –ø–æ–ª—É—á–∏–ª–æ—Å—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ)
ge		(N & V) or (!N & !V)		greater than or equal (–∑–Ω–∞–∫–æ–≤–æ–µ >=)
lt 		(N & !V) or (!N & V)		less than (–∑–Ω–∞–∫–æ–≤–æ–µ <)
gt		(!Z & N & V) or (!Z & !N & !V)	greater than (–∑–Ω–∞–∫–æ–≤–æ–µ >)
le		(Z or N & !V) or (!N & V)	less than or equal (–∑–Ω–∞–∫–æ–≤–æ–µ <=)

# ===
# if, while, do-until

—Ñ–æ—Ç–æ —Å —É—Å–ª–æ–≤–∏—è–º–∏ –¥–ª—è is, stays –∏ until (–ª–∏–±–æ —Å–ø–∏—Å–æ–∫ –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞): if_IS_else.png –≤ —ç—Ç–æ–π –∂–µ –ø–∞–ø–∫–µ.

—Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
if
	–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –ø—Ä–∏–º–µ—Ä—ã: tst rn / cmp ri, rj (–ø–æ —Ñ–∞–∫—Ç—É sub ri, rj –Ω–æ rj –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç—Å—è)
is <—É—Å–ª–æ–≤–∏–µ>
	# do smth
fi # –∑–∞–∫—Ä—ã—Ç—å if

while
	–ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, –ø—Ä–∏–º–µ—Ä—ã: tst rn / cmp ri, rj (–ø–æ —Ñ–∞–∫—Ç—É sub ri, rj –Ω–æ rj –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç—Å—è)
stays <—É—Å–ª–æ–≤–∏–µ> # —Ç–æ—Ç –∂–µ is, –Ω–æ –¥–ª—è while
	# do smth
wend # –∑–∞–∫—Ä—ã—Ç—å while


do
# do smth
until <—É—Å–ª–æ–≤–∏–µ> # —É—Å–ª–æ–≤–∏–µ —Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ –¥–ª—è is –∏ stays

CONTINUE BREAK —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–∞–∫–∂–µ –∫–∞–∫ –≤ —Å–∏:
continue ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Ü–∏–∫–ª–∞
break ‚Äî –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ —Ü–∏–∫–ª–∞ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–ª–µ–¥—É—é—â—É—é –∫–æ–º–∞–Ω–¥—É

# ===

–°–¢–ï–ö –†–ê–ë–û–¢–ê–ï–¢ –° –ö–û–ù–¶–ê, —Å–Ω–∞—á–∞–ª–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª–∞–¥—ë—Ç—Å—è –≤ —è—á–µ–π–∫—É 0xFF, –∑–∞—Ç–µ–º ‚Äî –≤ 0xFE, –ø–æ—Å–ª–µ ‚Äî 0xFD  –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ

push rn ‚Äî –∞–Ω–∞–ª–æ–≥ –Ω–∞ —Å–∏: SP--; *SP = rn
pop rn  ‚Äî –∞–Ω–∞–ª–æ–≥ –Ω–∞ —Å–∏: rn = *SP; SP++

# ===

asect <—á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 255> ‚Äî "–≥–æ–≤–æ—Ä–∏—Ç" –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä—É, —Å –∫–∞–∫–æ–≥–æ –∞–¥—Ä–µ—Å–∞ –Ω–∞—á–∞—Ç—å –≤—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–¥ –ø—Ä–æ–≥—Ä–∞–º–º—ã. –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–∏ asect 0x00 –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–¥ —Å –Ω–∞—á–∞–ª–∞

rsect <const> ‚Äî –∫–∞–∫ —è –ø–æ–Ω—è–ª, –æ–±—ä—è–≤–ª—è–µ—Ç –Ω–∞—á–∞–ª–æ –ø–æ–¥–ø—Ä–æ–≥—Ä–∞–º–º—ã –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ
# –ø—Ä–∏–º–µ—Ä:
_–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ_:
rsect mul
mul>  # –∏–º–µ–Ω–Ω–æ "mul>" –∞ –Ω–µ "mul:" —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –¥–ª—è rsect
	push r2 # save r2
	ldi r2, 0 # clr r2
	
	inc r1 # –∏–Ω–∞—á–µ 1 –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç
	while 
		dec r1
	stays ne
		add r0, r2
	wend
	move r2, r0 # result will in r0 (r0 = r2)
	pop r2 # restore r2
	
	rts # go back	
# –∫–æ–Ω–µ—Ü –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
# _–≤ –≥–ª–∞–≤–Ω–æ–º —Ñ–∞–π–ª–µ_ —Å—á–∏—Ç–∞–µ–º -3x+7
asect 0
mul: ext  # –æ–±—ä—è–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤–Ω–µ—à–Ω–µ–π (declare mul as an external label)
ldi r0, x # \
ld r0, r0 # / r0 = x
ldi r1, -3 # r1 = -3
jsr mul # goto mul, r0 = r0 * r1,  r0 = -3x
ldi r1, 7 # r1 = 7
add r1, r0 # r0 += r1,  r0 = -3x+7
halt
x: dc <—á–∏—Å–ª–æ>
end 
# –∫–æ–Ω–µ—Ü –≥–ª–∞–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞

tplate <name> ‚Äî –Ø –ù–ï –ü–û–ù–Ø–õ, –Ω–æ –æ–± —ç—Ç–æ–º –µ—Å—Ç—å –≤ –ª–µ–∫—Ü–∏–∏ 5. –Ω–µ–∫–∏–π malloc, –ø–∏—Å–∞—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ asect <—á–∏—Å–ª–æ>

# ===

addsp n ‚Äî SP += n
ldsa rn, offset ‚Äî rn = SP+offset
ldsp rn ‚Äî rn = SP
stsp rn ‚Äî –Ω–µ –æ—á–µ–Ω—å —Ä–∞–∑–æ–±—Ä–∞–ª—Å—è, —á—Ç–æ-—Ç–æ –æ—á–µ–Ω—å —Å—Ç—Ä–∞–Ω–Ω–æ–µ
# –ø—Ä–∏–º–µ—Ä:
                    stsp r0 ‚Äî –∞–Ω–∞–ª–æ–≥ –Ω–∞ —Å–∏: *SP = r1
stsp r1 / stsp r2 / stsp r3 ‚Äî –∞–Ω–∞–ª–æ–≥ –Ω–∞ —Å–∏: *SP = r0

# ===
# SUBROUTINES (–ø–æ–¥–ø—Ä–æ–≥—Ä–∞–º–º—ã)

jsr <const> ‚Äî —á—Ç–æ-—Ç–æ –ø–æ—Ö–æ–∂–µ–µ –Ω–∞ goto, —Ç–∞–∫–∂–µ –∫–ª–∞–¥—ë—Ç –≤ —Å—Ç–µ–∫ –∫—É–¥–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è
# —á—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –ø—Ä–∏ –≤—ã–∑–æ–≤–µ jsr: SP = SP-1, *SP = PC, PC = <const>
rts ‚Äî –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
# –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –≤—ã–∑–æ–≤–µ: PC = *SP; SP++
# –∏–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ: PC = pop(stack)
jsrr rn ‚Äî –∞–Ω–∞–ª–æ–≥ jsr, –Ω–æ –≤–º–µ—Å—Ç–æ <const> –∫–∞–∫–æ–π-—Ç–æ —Ä–µ–≥–∏—Å—Ç—Ä


# –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞: 
# main
ldi r0, 5
ldi r1, 4
jsr mult # "goto mult"
# –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ r0 = r0*r1

mult:
	push r2 # save r2
	ldi r2, 0 # clr r2
	
	inc r1 # –∏–Ω–∞—á–µ 1 –∏—Ç–µ—Ä–∞—Ü–∏–∏ –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç
	while 
		dec r1
	stays ne
		add r0, r2
	wend
	move r2, r0 # result will in r0 (r0 = r2)
	pop r2 # restore r2
	
	rts # go back, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã –ø–æ—Å–ª–µ jsr mult
# –∫–æ–Ω–µ—Ü –ø—Ä–∏–º–µ—Ä–∞

